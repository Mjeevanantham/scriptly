<div class="page" id="page-settings">
  <div style="padding: 20px; max-width: 600px; margin: 0 auto;">
    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
      <button onclick="window.router?.navigate('dashboard')" class="secondary" style="display: flex; align-items: center; gap: 4px;">
        <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" style="vertical-align: middle;">
          <path d="M11 8L6 13L5.293 12.293L9.586 8L5.293 3.707L6 3L11 8Z"/>
        </svg>
        Back
      </button>
    </div>
    <h1 style="margin-bottom: 8px;">Settings</h1>
    <p style="color: var(--text-secondary); margin-bottom: 24px;">
      Configure your Scriptly preferences
    </p>

    <div class="card">
      <h3 style="margin-bottom: 16px;">API Configuration</h3>
      
      <div class="form-group">
        <label class="form-label" for="settings-provider">LLM Provider</label>
        <select id="settings-provider" class="form-control">
          <option value="openai">OpenAI (GPT-4, GPT-3.5)</option>
          <option value="claude">Anthropic Claude</option>
          <option value="ollama">Ollama (Local)</option>
          <option value="custom">Custom Endpoint</option>
        </select>
      </div>

      <div class="form-group">
        <label class="form-label" for="settings-api-key">API Key</label>
        <input type="password" id="settings-api-key" class="form-control" placeholder="Configure API key" readonly />
        <div class="form-help">
          <button id="configure-api-btn" class="secondary" style="margin-top: 8px;">Configure API Key</button>
        </div>
      </div>

      <div id="settings-status" style="margin-top: 12px;">
        <p style="color: var(--text-secondary); font-size: 0.9rem;">Checking status...</p>
      </div>
    </div>

    <div class="card" style="margin-top: 16px;">
      <h3 style="margin-bottom: 16px;">Model Settings</h3>
      
      <div class="form-group">
        <label class="form-label" for="settings-model">Model Name</label>
        <input type="text" id="settings-model" class="form-control" placeholder="gpt-4" />
        <div class="form-help">The model to use for AI responses</div>
      </div>

      <div class="form-group">
        <label class="form-label" for="settings-temperature">Temperature</label>
        <input type="range" id="settings-temperature" min="0" max="1" step="0.1" value="0.3" />
        <div style="display: flex; justify-content: space-between; font-size: 0.875rem; color: var(--text-secondary);">
          <span>Focused (0)</span>
          <span id="temp-value">0.3</span>
          <span>Creative (1)</span>
        </div>
        <div class="form-help">Controls randomness of responses</div>
      </div>

      <button id="save-settings-btn" style="width: 100%; margin-top: 8px;">Save Settings</button>
    </div>

    <div class="card" style="margin-top: 16px;">
      <h3 style="margin-bottom: 16px;">Storage</h3>
      <button id="clear-storage-btn" class="secondary" style="width: 100%;">Clear All Storage & Reset</button>
      <div class="form-help" style="margin-top: 8px;">
        This will clear all API keys, settings, and conversation history
      </div>
    </div>
  </div>
</div>

<script>
window.initSettingsPage = function() {
  const providerSelect = document.getElementById('settings-provider');
  const apiKeyInput = document.getElementById('settings-api-key');
  const modelInput = document.getElementById('settings-model');
  const tempSlider = document.getElementById('settings-temperature');
  const tempValue = document.getElementById('temp-value');
  const configureBtn = document.getElementById('configure-api-btn');
  const saveBtn = document.getElementById('save-settings-btn');
  const clearBtn = document.getElementById('clear-storage-btn');
  const statusDiv = document.getElementById('settings-status');

  // Load current settings
  if (window.vscode) {
    window.vscode.postMessage({ command: 'getSettings' });

    const listener = function(event) {
      const message = event.data;
      if (message.command === 'settings') {
        window.removeEventListener('message', listener);
        
        if (message.provider) {
          providerSelect.value = message.provider;
        }
        if (message.modelName) {
          modelInput.value = message.modelName;
        }
        if (message.temperature !== undefined) {
          tempSlider.value = message.temperature;
          tempValue.textContent = message.temperature;
        }
        if (message.hasApiKey) {
          apiKeyInput.value = '••••••••••••';
          statusDiv.innerHTML = '<p style="color: var(--success-fg);">✓ API Key Configured</p>';
        } else {
          statusDiv.innerHTML = '<p style="color: var(--error-fg);">⚠ No API key configured</p>';
        }
      }
    };
    window.addEventListener('message', listener);
  }

  // Temperature slider
  tempSlider.addEventListener('input', function() {
    tempValue.textContent = tempSlider.value;
  });

  // Configure API button
  configureBtn.addEventListener('click', function() {
    if (window.vscode) {
      window.vscode.postMessage({ command: 'openConfigureDialog' });
    }
  });

  // Save settings
  saveBtn.addEventListener('click', function() {
    if (window.vscode) {
      window.vscode.postMessage({
        command: 'saveSettings',
        provider: providerSelect.value,
        modelName: modelInput.value,
        temperature: parseFloat(tempSlider.value),
      });

      saveBtn.disabled = true;
      saveBtn.textContent = 'Saving...';

      const listener = function(event) {
        const message = event.data;
        if (message.command === 'settingsSaved') {
          window.removeEventListener('message', listener);
          saveBtn.disabled = false;
          saveBtn.textContent = 'Save Settings';
          
          if (message.success) {
            saveBtn.textContent = 'Saved!';
            setTimeout(() => {
              saveBtn.textContent = 'Save Settings';
            }, 2000);
          }
        }
      };
      window.addEventListener('message', listener);
    }
  });

  // Clear storage
  clearBtn.addEventListener('click', function() {
    if (confirm('Are you sure you want to clear all storage? This cannot be undone.')) {
      if (window.vscode) {
        window.vscode.postMessage({ command: 'clearStorage' });
      }
    }
  });
};
</script>
